#!/bin/bash
# ==============================================================
#  install_monitor.sh
#  ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° "test"
#  Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ:
#   - Linux Ñ systemd
#   - root-Ð¿Ñ€Ð°Ð²Ð° Ð¸Ð»Ð¸ sudo
# ==============================================================

set -e  # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

# --- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ------------------------------------------------
SERVICE_NAME="process-monitor"                      # Ð˜Ð¼Ñ ÑÐ»ÑƒÐ¶Ð±Ñ‹
SCRIPT_PATH="/usr/local/bin/process_monitor.sh"     # ÐŸÑƒÑ‚ÑŒ Ðº bash-ÑÐºÑ€Ð¸Ð¿Ñ‚Ñƒ
LOG_FILE="/var/log/monitoring.log"                  # Ð¤Ð°Ð¹Ð» Ð»Ð¾Ð³Ð°
STATE_FILE="/var/run/test_monitor_prev_pid"         # PID Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°
MONITOR_URL="https://test.com/monitoring/test/api"  # URL Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
PROCESS_NAME="test"                                 # Ð˜Ð¼Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ
# --------------------------------------------------------------

echo "ðŸš€ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° '$PROCESS_NAME'..."

# ==============================================================
# 1ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
# ==============================================================

sudo tee "$SCRIPT_PATH" > /dev/null <<EOF
#!/bin/bash
# process_monitor.sh â€” Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° "$PROCESS_NAME"

LOG_FILE="$LOG_FILE"
STATE_FILE="$STATE_FILE"
PROCESS_NAME="$PROCESS_NAME"
MONITOR_URL="$MONITOR_URL"

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ PID Ñ†ÐµÐ»ÐµÐ²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
PID=\$(pgrep -x "\$PROCESS_NAME")

# Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ â€” Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð´ÐµÐ»Ð°ÐµÐ¼
if [ -z "\$PID" ]; then
    exit 0
fi

# Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ PID Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°, ÐµÑÐ»Ð¸ Ð¾Ð½ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ -f "\$STATE_FILE" ]; then
    PREV_PID=\$(cat "\$STATE_FILE")
else
    PREV_PID=""
fi

# Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (PID Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»ÑÑ), Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ
if [ -n "\$PREV_PID" ] && [ "\$PREV_PID" != "\$PID" ]; then
    echo "\$(date '+%Y-%m-%d %H:%M:%S') - ÐŸÑ€Ð¾Ñ†ÐµÑÑ \$PROCESS_NAME Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (Ð½Ð¾Ð²Ñ‹Ð¹ PID: \$PID)" >> "\$LOG_FILE"
fi

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ PID Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ
echo "\$PID" > "\$STATE_FILE"

# ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ HTTPS-Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" "\$MONITOR_URL")

# Ð•ÑÐ»Ð¸ ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (ÐºÐ¾Ð´ Ð½Ðµ 2xx) â€” Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð² Ð»Ð¾Ð³
if [[ "\$HTTP_CODE" -lt 200 || "\$HTTP_CODE" -ge 300 ]]; then
    echo "\$(date '+%Y-%m-%d %H:%M:%S') - Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ (\$MONITOR_URL, ÐºÐ¾Ð´: \$HTTP_CODE)" >> "\$LOG_FILE"
fi
EOF

# Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
sudo chmod +x "$SCRIPT_PATH"
echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑÐ¾Ð·Ð´Ð°Ð½: $SCRIPT_PATH"

# ==============================================================
# 2ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd unit-Ñ„Ð°Ð¹Ð»Ð°
# ==============================================================

sudo tee "/etc/systemd/system/${SERVICE_NAME}.service" > /dev/null <<EOF
[Unit]
Description=Monitor process "$PROCESS_NAME"
After=network.target

[Service]
Type=oneshot
ExecStart=$SCRIPT_PATH
EOF

echo "âœ… systemd unit ÑÐ¾Ð·Ð´Ð°Ð½: /etc/systemd/system/${SERVICE_NAME}.service"

# ==============================================================
# 3ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð° (Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ)
# ==============================================================

sudo tee "/etc/systemd/system/${SERVICE_NAME}.timer" > /dev/null <<EOF
[Unit]
Description=Run $SERVICE_NAME every minute

[Timer]
OnBootSec=30sec             # Ð—Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· 30 ÑÐµÐºÑƒÐ½Ð´ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
OnUnitActiveSec=1min        # ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 1 Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
Unit=${SERVICE_NAME}.service

[Install]
WantedBy=timers.target
EOF

echo "âœ… systemd timer ÑÐ¾Ð·Ð´Ð°Ð½: /etc/systemd/system/${SERVICE_NAME}.timer"

# ==============================================================
# 4ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° Ð»Ð¾Ð³Ð°
# ==============================================================

sudo touch "$LOG_FILE"
sudo chmod 664 "$LOG_FILE"
echo "âœ… Ð¤Ð°Ð¹Ð» Ð»Ð¾Ð³Ð° Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½: $LOG_FILE"

# ==============================================================
# 5ï¸âƒ£ ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸ Ð·Ð°Ð¿ÑƒÑÐº Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð°
# ==============================================================

sudo systemctl daemon-reload
sudo systemctl enable --now "${SERVICE_NAME}.timer"

echo "âœ… Ð¢Ð°Ð¹Ð¼ÐµÑ€ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð²:"
sudo systemctl list-timers | grep "$SERVICE_NAME" || true

echo "ðŸŽ‰ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
